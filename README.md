# x86-64 Assembly (Intel 64bit)

## 📦 レジスタ一覧（64ビット）

| レジスタ   | 用途                                          | 呼び出し間で保持 | 具体例（NASM）                                      |
|------------|-----------------------------------------------|------------------|----------------------------------------------------|
| `%rax`     | 一時レジスタ・関数戻り値                       | No               | `mov rax, 10` ; raxに10をセット                    |
| `%rbx`     | callee-saved（呼ばれた関数が保存）             | Yes              | `mov rbx, rax` ; rbxにraxの値をコピー              |
| `%rcx`     | 第4引数、またはループカウンタなど               | No               | `mov rcx, 5` ; ループカウンタを5に設定             |
| `%rdx`     | 第3引数                                        | No               | `mov rdx, rdi` ; 第3引数にrdiの値を入れる           |
| `%rsp`     | スタックポインタ                               | Yes              | `push rax` ; raxをスタックに積む                    |
| `%rbp`     | ベースポインタ（フレームポインタ）             | Yes              | `mov rbp, rsp` ; スタックフレーム開始               |
| `%rsi`     | 第2引数                                        | No               | `mov rsi, [rbp+16]` ; 第2引数をメモリからロード     |
| `%rdi`     | 第1引数                                        | No               | `mov rdi, 1` ; 第1引数に1をセット                   |
| `%r8`      | 第5引数                                        | No               | `mov r8, 100` ; 第5引数に100をセット                 |
| `%r9`      | 第6引数                                        | No               | `mov r9, 200` ; 第6引数に200をセット                 |
| `%r10-%r11`| 一時レジスタ                                   | No               | `mov r10, rax` ; 一時的にraxを保存                   |
| `%r12-%r15`| callee-saved                                   | Yes              | `mov r12, rbx` ; r12を呼び出し側保存用に使う         |

### レジスタの使用ルール

**スクラッチレジスタ（呼び出し先が保存不要）**
- `rax`, `rcx`, `rdx`, `rsi`, `rdi`, `r8`〜`r11`: これらは「スクラッチレジスタ」と呼ばれ、関数の中で自由に上書きしてOKなルールです。

**Callee-savedレジスタ（呼び出し先が保存必須）**
- `rbx`, `rbp`, `r12`〜`r15`: これらは「呼び出し元が使っているかもしれないので、書き換えるなら元の値を保存（退避）しなければならない」というルールがあります。

### レジスタの分割構造

アセンブリ言語（x86-64）では、一つの大きなレジスタを、サイズに合わせて分割して扱うことができます。

**レジスタの構造図**

`rax` という64ビットの巨大な箱の中に、小さい箱が含まれているイメージです。

```
rax: 64ビット全体（8バイト）
│
├─ eax: 下位32ビット（4バイト）
│  │
│  ├─ ax: 下位16ビット（2バイト）
│  │  │
│  │  ├─ al: 下位8ビット（1バイト） ← これが今回使われているもの
│  │  └─ ah: ax のうちの上位8ビット
```

同様に、他のレジスタ（`rbx`, `rcx`, `rdx`, `rsi`, `rdi` など）も同じ構造を持っています。

| レジスタ名 | ビット数 | 説明 |
|------------|----------|------|
| `rax` | 64ビット | 全体（8バイト） |
| `eax` | 32ビット | 下位32ビット（4バイト） |
| `ax` | 16ビット | 下位16ビット（2バイト） |
| `al` | 8ビット | 下位8ビット（1バイト） |
| `ah` | 8ビット | ax のうちの上位8ビット |

### スタック管理レジスタ (`rsp`, `rbp`)

スタックは「後入れ先出し（LIFO）」のデータ構造で、メモリの高いアドレスから低いアドレスに向かって成長します。

- **`rsp` (Stack Pointer)**: 
  - 現在のスタックの「最上部（もっとも低いアドレス）」を常に指します。
  - `push` 命令を実行すると減少し、`pop` 命令を実行すると増加します。
- **`rbp` (Base Pointer / Frame Pointer)**:
  - 現在の関数の「スタックフレーム（活動記録）」の基準点を指します。
  - 関数内でスタックに積まれたローカル変数や引数に、固定のオフセット（例: `[rbp - 8]`）でアクセスするために使われます。
  - 関数の最初で `push rbp` し、`mov rbp, rsp` とすることで、新しいスタックフレームを作成するのが一般的です。

## 🔧 基本命令

### データ操作

| 命令             | 説明                             | 例                      |
|------------------|----------------------------------|-------------------------|
| `mov dst, src`   | データ転送                       | `mov rax, 5`            |
| `lea dst, [src]` | アドレス計算（ポインタ）         | `lea rax, [rbx + 8]`    |

### 算術演算

| 命令         | 説明                 | 例                      |
|--------------|----------------------|-------------------------|
| `add r1, r2` | 加算（r1 += r2）     | `add rax, rbx`          |
| `sub r1, r2` | 減算（r1 -= r2）     | `sub rax, 1`            |
| `imul r1, r2`| 符号付き乗算         | `imul rax, rbx`         |
| `idiv r2`    | 符号付き除算         | `cqo` → `idiv rcx`      |

### 分岐・ジャンプ

| 命令         | 説明                          | 例                     |
|--------------|-------------------------------|------------------------|
| `cmp r1, r2` | 比較（r1 - r2）               | `cmp rax, 10`          |
| `je label`   | 等しければジャンプ           | `je .equal_case`       |
| `jne label`  | 等しくなければジャンプ       | `jne .not_equal`       |
| `jmp label`  | 無条件ジャンプ               | `jmp .loop_start`      |


## 🔁 System V ABI の関数引数の渡し方（Linux）

| 引数の順番 | レジスタ |
|------------|----------|
| 第1引数    | `%rdi`   |
| 第2引数    | `%rsi`   |
| 第3引数    | `%rdx`   |
| 第4引数    | `%rcx`   |
| 第5引数    | `%r8`    |
| 第6引数    | `%r9`    |
| それ以降   | スタック |
